<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRUTAL V4 - Core Integration Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f0f0f0;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 40px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            margin-top: 0;
            color: #0066cc;
            font-size: 18px;
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status.pass {
            background: #d4edda;
            color: #155724;
        }
        
        .status.fail {
            background: #f8d7da;
            color: #721c24;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
        }
        
        #summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .metric {
            display: inline-block;
            margin: 0 15px;
            padding: 10px 20px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .metric strong {
            display: block;
            font-size: 24px;
            color: #0066cc;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ¯ BRUTAL V4 - Core Integration Test</h1>
    
    <div id="summary">
        <h2>Test Summary</h2>
        <div class="metrics">
            <div class="metric">
                <strong id="total-tests">0</strong>
                <span>Total Tests</span>
            </div>
            <div class="metric">
                <strong id="passed-tests">0</strong>
                <span>Passed</span>
            </div>
            <div class="metric">
                <strong id="failed-tests">0</strong>
                <span>Failed</span>
            </div>
            <div class="metric">
                <strong id="load-time">0ms</strong>
                <span>Load Time</span>
            </div>
        </div>
    </div>
    
    <div class="test-grid" id="test-container"></div>
    
    <brutal-error-boundary show-details>
        <div id="component-tests"></div>
    </brutal-error-boundary>

    <script type="module">
        const startTime = performance.now();
        
        // Import all core modules
        import {
            initBrutal,
            PolyfillStrategy,
            Registry,
            ConfigLoader,
            EnhancedBrutalComponent,
            HookPhase,
            TemplateEngine,
            directiveManager,
            EventManager,
            eventManager,
            AppEventBus,
            globalEventBus,
            BrutalErrorBoundary
        } from '../core/index.js';
        
        const testContainer = document.getElementById('test-container');
        const tests = [];
        let passed = 0;
        let failed = 0;
        
        // Test runner
        function runTest(name, testFn) {
            const section = document.createElement('div');
            section.className = 'test-section';
            
            try {
                const result = testFn();
                const success = result !== false;
                
                if (success) {
                    passed++;
                    section.innerHTML = `
                        <h2>${name} <span class="status pass">PASS</span></h2>
                        <div class="test-result">${result || 'Test passed successfully'}</div>
                    `;
                } else {
                    failed++;
                    section.innerHTML = `
                        <h2>${name} <span class="status fail">FAIL</span></h2>
                        <div class="test-result">Test failed</div>
                    `;
                }
            } catch (error) {
                failed++;
                section.innerHTML = `
                    <h2>${name} <span class="status fail">ERROR</span></h2>
                    <div class="test-result">${error.message}</div>
                `;
            }
            
            testContainer.appendChild(section);
            tests.push({ name, passed: passed > failed });
        }
        
        // Run tests
        async function runAllTests() {
            // 1. Framework initialization
            runTest('Framework Initialization', () => {
                return window.BRUTAL && window.BRUTAL.initialized ? 
                    `Version: ${window.BRUTAL.version}` : false;
            });
            
            // 2. Polyfill Strategy
            runTest('Polyfill Strategy', () => {
                const features = ['constructableStyleSheets', 'requestIdleCallback'];
                const detected = features.map(f => 
                    `${f}: ${PolyfillStrategy.detect(f) ? 'âœ“' : 'âœ—'}`
                );
                return detected.join(', ');
            });
            
            // 3. Registry
            runTest('Component Registry', () => {
                class TestComp extends EnhancedBrutalComponent {}
                Registry.register('test-registry-comp', TestComp);
                const retrieved = Registry.get('test-registry-comp');
                return retrieved === TestComp ? 
                    'Registration and retrieval working' : false;
            });
            
            // 4. Config Loader
            runTest('Configuration Loader', () => {
                ConfigLoader.set('test.value', 123);
                const value = ConfigLoader.get('test.value');
                return value === 123 ? 
                    `Config get/set working. Environment: ${ConfigLoader.get('environment')}` : false;
            });
            
            // 5. Template Engine
            runTest('Template Engine', () => {
                const template = TemplateEngine.html`<div>Test</div>`;
                return template instanceof HTMLTemplateElement ? 
                    'Template creation working' : false;
            });
            
            // 6. Directive Manager
            runTest('Directive Manager', () => {
                const directives = directiveManager.getAll();
                return directives.length > 0 ? 
                    `${directives.length} directives registered: ${directives.join(', ')}` : false;
            });
            
            // 7. Event Manager
            runTest('Event Manager', () => {
                let handled = false;
                const off = eventManager.on('click', 'button', () => { handled = true; });
                
                // Simulate click
                const btn = document.createElement('button');
                document.body.appendChild(btn);
                btn.click();
                document.body.removeChild(btn);
                off();
                
                return handled ? 'Event delegation working' : false;
            });
            
            // 8. Event Bus
            runTest('Event Bus', () => {
                let received = false;
                globalEventBus.once('test:event', () => { received = true; });
                globalEventBus.emit('test:event');
                return received ? 'Event bus pub/sub working' : false;
            });
            
            // 9. Lifecycle Hooks
            runTest('Lifecycle Hooks', () => {
                class TestHookComp extends EnhancedBrutalComponent {
                    constructor() {
                        super();
                        this.hooksCalled = [];
                        
                        Object.values(HookPhase).forEach(phase => {
                            this.hook(phase, () => {
                                this.hooksCalled.push(phase);
                            });
                        });
                    }
                }
                
                Registry.register('test-hook-comp', TestHookComp);
                const comp = new TestHookComp();
                
                return comp.hooksCalled.length > 0 ? 
                    `${comp.hooksCalled.length} hooks registered` : false;
            });
            
            // 10. Error Boundary
            runTest('Error Boundary', () => {
                const boundary = document.querySelector('brutal-error-boundary');
                return boundary instanceof BrutalErrorBoundary ? 
                    'Error boundary component loaded' : false;
            });
            
            // Update summary
            const loadTime = Math.round(performance.now() - startTime);
            document.getElementById('total-tests').textContent = tests.length;
            document.getElementById('passed-tests').textContent = passed;
            document.getElementById('failed-tests').textContent = failed;
            document.getElementById('load-time').textContent = `${loadTime}ms`;
        }
        
        // Initialize and run tests
        initBrutal({ debug: true }).then(() => {
            console.log('BRUTAL V4 initialized, running tests...');
            runAllTests();
        });
    </script>
</body>
</html>