#!/bin/bash
# BRUTAL V6 Foundation Pre-commit Hook
# This validation is NOT negotiable

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "🛡️  BRUTAL Foundation Validation..."

# Get the root directory
ROOT_DIR=$(git rev-parse --show-toplevel)
cd "$ROOT_DIR"

# First, show North Star reminder
if [ -f "foundation/enforce/north-star-check.sh" ]; then
  bash foundation/enforce/north-star-check.sh
fi

# Check if foundation validation exists
if [ ! -f "foundation/validate.js" ]; then
  # Try to compile it first
  if [ -f "foundation/validate.ts" ]; then
    echo "📦 Compiling foundation..."
    npx tsc foundation/*.ts --outDir foundation --module commonjs --target es2020 2>/dev/null || {
      echo -e "${YELLOW}⚠️  Foundation not compiled, skipping validation${NC}"
      exit 0
    }
  else
    echo -e "${YELLOW}⚠️  Foundation not found, skipping validation${NC}"
    exit 0
  fi
fi

# Run validation
node -e "
const { validate } = require('./foundation');

(async () => {
  try {
    const result = await validate('.', { verbose: true });
    
    if (!result.valid) {
      console.error(result.summary);
      process.exit(1);
    } else {
      console.log('✅ All validations passed');
    }
  } catch (error) {
    console.error('❌ Validation error:', error.message);
    process.exit(1);
  }
})();
" || {
  echo -e "${RED}❌ Foundation validation failed${NC}"
  echo -e "${YELLOW}🔧 Run: npm run foundation:fix${NC}"
  echo -e "${YELLOW}📖 Details: npm run foundation:validate${NC}"
  exit 1
}

# Detect bypass attempts
if [ -n "$FORCE" ] || [ -n "$SKIP_VALIDATION" ] || [ -n "$NO_VERIFY" ]; then
  echo -e "${RED}🚨 Nice try. Validation is MANDATORY.${NC}"
  echo -e "${RED}🚨 FORCE, SKIP_VALIDATION, and NO_VERIFY are ignored.${NC}"
  exit 1
fi

# Check for --no-verify flag (git bypass attempt)
if [ "$GIT_BYPASS" = "1" ]; then
  echo -e "${RED}🚨 --no-verify detected and BLOCKED.${NC}"
  echo -e "${RED}🚨 Foundation validation cannot be skipped.${NC}"
  exit 1
fi

echo -e "${GREEN}✅ Foundation validation passed${NC}"