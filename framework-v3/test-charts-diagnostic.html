<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charts Diagnostic Test - BRUTAL V3</title>
    <style>
        body {
            padding: 20px;
            font-family: monospace;
            background: #000;
            color: #0f0;
        }
        h1 { text-shadow: 0 0 10px #0f0; }
        .diagnostic { 
            background: #111; 
            padding: 20px; 
            border: 1px solid #0f0;
            margin: 20px 0;
            border-radius: 4px;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
        .info { color: #0ff; }
        button {
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0f0;
            color: #000;
        }
        .test-chart {
            height: 400px;
            border: 2px solid #0f0;
            margin: 20px 0;
        }
        .mini-chart {
            height: 200px;
            border: 1px solid #0f0;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Charts Component Diagnostic</h1>
    
    <button onclick="runDiagnostic()">Run Full Diagnostic</button>
    <button onclick="testMinimal()">Test Minimal Chart</button>
    <button onclick="testAllTypes()">Test All Chart Types</button>
    <button onclick="testPerformance()">Test Performance</button>
    <button onclick="checkConsoleErrors()">Check Console</button>
    
    <div id="log" class="diagnostic"></div>
    
    <!-- Test Charts -->
    <brutal-charts id="chart1" class="test-chart" type="line" theme="brutal"></brutal-charts>
    
    <div id="chartGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
        <brutal-charts id="chartBar" class="mini-chart" type="bar"></brutal-charts>
        <brutal-charts id="chartPie" class="mini-chart" type="pie"></brutal-charts>
        <brutal-charts id="chartRadar" class="mini-chart" type="radar"></brutal-charts>
        <brutal-charts id="chartHeatmap" class="mini-chart" type="heatmap"></brutal-charts>
    </div>

    <script type="module">
        import { Charts } from './04-components/ui/Charts.js';
        
        const log = (msg, type = 'info') => {
            const logEl = document.getElementById('log');
            logEl.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        };
        
        // Override console to catch errors
        const originalError = console.error;
        const originalWarn = console.warn;
        let consoleErrors = [];
        let consoleWarnings = [];
        
        console.error = function(...args) {
            originalError.apply(console, args);
            consoleErrors.push(args.join(' '));
            log('Console Error: ' + args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            consoleWarnings.push(args.join(' '));
            log('Console Warning: ' + args.join(' '), 'warning');
        };
        
        window.runDiagnostic = async function() {
            log('=== STARTING CHARTS DIAGNOSTIC ===', 'warning');
            const chart = document.getElementById('chart1');
            
            // 1. Check basic initialization
            log('\\n1. INITIALIZATION CHECK', 'info');
            try {
                log(`Chart element exists: ${!!chart}`, chart ? 'success' : 'error');
                log(`Is Charts instance: ${chart instanceof Charts}`, chart instanceof Charts ? 'success' : 'error');
                log(`Has shadowRoot: ${!!chart.shadowRoot}`, chart.shadowRoot ? 'success' : 'error');
                
                // Check template
                if (typeof chart.template === 'function') {
                    const templateResult = chart.template();
                    log(`template() returns: ${typeof templateResult}`, typeof templateResult === 'string' ? 'success' : 'error');
                    
                    if (templateResult && typeof templateResult === 'string') {
                        log(`Template length: ${templateResult.length} chars`, 'info');
                        
                        // Check for common issues
                        if (templateResult.includes('[object Object]')) {
                            log('ERROR: Template contains [object Object]', 'error');
                        }
                        if (templateResult.includes('${')) {
                            log('ERROR: Template contains unprocessed literals', 'error');
                        }
                        if (!templateResult.includes('charts-container')) {
                            log('ERROR: Template missing container element', 'error');
                        }
                    }
                }
                
            } catch (e) {
                log(`Initialization error: ${e.message}`, 'error');
                console.error(e);
            }
            
            // 2. Check internal state
            log('\\n2. INTERNAL STATE CHECK', 'info');
            try {
                log(`_datasets: ${Array.isArray(chart._datasets)} (${chart._datasets?.length || 0} datasets)`, 'info');
                log(`_config: ${typeof chart._config}`, 'info');
                log(`  - type: ${chart._config?.type}`, 'info');
                log(`  - theme: ${chart._config?.theme}`, 'info');
                log(`  - webglEnabled: ${chart._config?.webglEnabled}`, 'info');
                log(`  - interactive: ${chart._config?.interactive}`, 'info');
                
                // Check dimensions
                log(`_dimensions: width=${chart._dimensions?.width}, height=${chart._dimensions?.height}`, 'info');
                
                // Check scales
                log(`_scales: x=${!!chart._scales?.x}, y=${!!chart._scales?.y}`, 'info');
                
                // Check WebGL
                log(`_gl (WebGL context): ${!!chart._gl}`, chart._gl ? 'success' : 'warning');
                log(`_canvas: ${!!chart._canvas}`, 'info');
                log(`_ctx (2D context): ${!!chart._ctx}`, chart._ctx ? 'success' : 'error');
                
                if (chart._gl) {
                    log(`WebGL version: ${chart._gl.getParameter(chart._gl.VERSION)}`, 'info');
                    log(`_programs: ${Object.keys(chart._programs || {}).length} shaders`, 'info');
                    log(`  - Shaders: ${Object.keys(chart._programs || {}).join(', ')}`, 'info');
                }
                
            } catch (e) {
                log(`State check error: ${e.message}`, 'error');
            }
            
            // 3. Check render loop
            log('\\n3. RENDER LOOP CHECK', 'info');
            try {
                log(`RAF ID: ${chart._rafId}`, chart._rafId ? 'success' : 'error');
                log(`FPS: ${chart._fps?.toFixed(1) || 'N/A'}`, 'info');
                log(`Last frame: ${chart._lastFrame}`, 'info');
                log(`Needs redraw: ${chart._needsRedraw}`, 'info');
                log(`Is animating: ${chart._isAnimating}`, 'info');
                log(`Animation progress: ${chart._animationProgress}`, 'info');
                
            } catch (e) {
                log(`Render loop error: ${e.message}`, 'error');
            }
            
            // 4. Check DOM structure
            log('\\n4. DOM STRUCTURE CHECK', 'info');
            try {
                const container = chart.shadowRoot?.querySelector('.charts-container');
                const header = chart.shadowRoot?.querySelector('.charts-header');
                const controls = chart.shadowRoot?.querySelector('.charts-controls');
                const viewport = chart.shadowRoot?.querySelector('.charts-viewport');
                const canvas = chart.shadowRoot?.querySelector('.charts-canvas');
                const webglCanvas = chart.shadowRoot?.querySelector('.charts-webgl-canvas');
                const tooltip = chart.shadowRoot?.querySelector('.charts-tooltip');
                
                log(`Container: ${!!container}`, container ? 'success' : 'error');
                log(`Header: ${!!header}`, header ? 'success' : 'error');
                log(`Controls: ${!!controls}`, controls ? 'success' : 'error');
                log(`Viewport: ${!!viewport}`, viewport ? 'success' : 'error');
                log(`Canvas: ${!!canvas}`, canvas ? 'success' : 'error');
                log(`WebGL canvas: ${!!webglCanvas}`, webglCanvas ? 'success' : 'warning');
                log(`Tooltip: ${!!tooltip}`, tooltip ? 'success' : 'error');
                
                // Check control buttons
                const buttons = chart.shadowRoot?.querySelectorAll('.charts-control');
                log(`Control buttons: ${buttons?.length || 0}`, 'info');
                buttons?.forEach(btn => {
                    const action = btn.dataset.action;
                    log(`  - Button: ${action}`, 'info');
                });
                
                // Check canvas dimensions
                if (canvas) {
                    log(`Canvas dimensions: ${canvas.width}x${canvas.height}`, 'info');
                    log(`Canvas style: ${canvas.style.width}x${canvas.style.height}`, 'info');
                }
                
            } catch (e) {
                log(`DOM check error: ${e.message}`, 'error');
            }
            
            // 5. Test data rendering
            log('\\n5. DATA RENDERING TEST', 'info');
            try {
                // Set test data
                const testData = [{
                    label: 'Test Dataset',
                    color: '#00ff00',
                    data: [
                        { x: 0, y: 10 },
                        { x: 1, y: 20 },
                        { x: 2, y: 15 },
                        { x: 3, y: 25 },
                        { x: 4, y: 30 }
                    ]
                }];
                
                chart.setData(testData);
                await new Promise(r => setTimeout(r, 500));
                
                log(`Data set successfully`, 'success');
                log(`Datasets after setData: ${chart._datasets.length}`, 'info');
                log(`Data points: ${chart._datasets[0]?.data?.length || 0}`, 'info');
                log(`Animation started: ${chart._isAnimating}`, 'info');
                
                // Check if scales updated
                if (chart._scales.x && chart._scales.y) {
                    log(`X scale domain: [${chart._scales.x.domain}]`, 'info');
                    log(`Y scale domain: [${chart._scales.y.domain}]`, 'info');
                } else {
                    log('ERROR: Scales not updated', 'error');
                }
                
            } catch (e) {
                log(`Data rendering error: ${e.message}`, 'error');
            }
            
            // 6. Test interactions
            log('\\n6. INTERACTION TEST', 'info');
            try {
                // Test zoom
                const initialZoom = chart._zoom?.x || 1;
                chart.zoom(1.5);
                log(`Zoom after zoom(1.5): ${chart._zoom?.x}`, chart._zoom?.x === initialZoom * 1.5 ? 'success' : 'error');
                
                // Test reset
                chart.reset();
                log(`Zoom after reset: ${chart._zoom?.x}`, chart._zoom?.x === 1 ? 'success' : 'error');
                log(`Pan after reset: x=${chart._pan?.x}, y=${chart._pan?.y}`, 'info');
                
                // Test button clicks
                const zoomInBtn = chart.shadowRoot?.querySelector('[data-action="zoom-in"]');
                if (zoomInBtn) {
                    zoomInBtn.click();
                    await new Promise(r => setTimeout(r, 100));
                    log(`Zoom after button click: ${chart._zoom?.x}`, chart._zoom?.x > 1 ? 'success' : 'error');
                }
                
            } catch (e) {
                log(`Interaction test error: ${e.message}`, 'error');
            }
            
            // 7. Test chart type switching
            log('\\n7. CHART TYPE SWITCHING', 'info');
            try {
                const types = ['line', 'bar', 'area', 'scatter'];
                for (const type of types) {
                    chart.setType(type);
                    await new Promise(r => setTimeout(r, 300));
                    log(`Changed to ${type}: ${chart._config.type === type}`, chart._config.type === type ? 'success' : 'error');
                }
                
            } catch (e) {
                log(`Type switching error: ${e.message}`, 'error');
            }
            
            // 8. Performance check
            log('\\n8. PERFORMANCE CHECK', 'info');
            
            // Add more data points
            const largeData = [{
                label: 'Performance Test',
                data: Array(100).fill(0).map((_, i) => ({
                    x: i,
                    y: Math.sin(i * 0.1) * 50 + 50
                }))
            }];
            
            chart.setData(largeData);
            await new Promise(r => setTimeout(r, 1000));
            
            log(`FPS with 100 points: ${chart._fps?.toFixed(1) || 'N/A'}`, chart._fps > 30 ? 'success' : 'warning');
            log(`Particles: ${chart._particles?.length || 0}`, 'info');
            
            // 9. Check for memory leaks
            log('\\n9. MEMORY LEAK CHECK', 'info');
            const initialListeners = chart._eventListeners ? Object.keys(chart._eventListeners).length : 0;
            
            // Add and remove event listener
            const testHandler = () => {};
            chart.addEventListener('zoom', testHandler);
            chart.removeEventListener('zoom', testHandler);
            
            const finalListeners = chart._eventListeners ? Object.keys(chart._eventListeners).length : 0;
            log(`Event listeners cleaned up: ${finalListeners === initialListeners}`, finalListeners === initialListeners ? 'success' : 'error');
            
            // Summary
            log('\\n=== DIAGNOSTIC COMPLETE ===', 'warning');
            log(`Console errors: ${consoleErrors.length}`, consoleErrors.length === 0 ? 'success' : 'error');
            log(`Console warnings: ${consoleWarnings.length}`, consoleWarnings.length === 0 ? 'success' : 'warning');
            
            // Final render check
            log('\\nFINAL RENDER CHECK', 'info');
            const ctx = chart._ctx;
            if (ctx) {
                // Check if canvas has been drawn to
                const imageData = ctx.getImageData(0, 0, 1, 1);
                const hasContent = imageData.data.some(pixel => pixel > 0);
                log(`Canvas has rendered content: ${hasContent}`, hasContent ? 'success' : 'error');
            }
        };
        
        window.testMinimal = function() {
            log('Creating minimal chart...', 'info');
            
            const minimal = document.createElement('brutal-charts');
            minimal.style.height = '200px';
            minimal.style.border = '1px solid #0f0';
            
            document.body.appendChild(minimal);
            
            setTimeout(() => {
                log(`Minimal chart created`, 'success');
                log(`Has shadowRoot: ${!!minimal.shadowRoot}`, minimal.shadowRoot ? 'success' : 'error');
                log(`Canvas found: ${!!minimal.shadowRoot?.querySelector('.charts-canvas')}`, 'info');
                
                // Set simple data
                minimal.setData([{
                    label: 'Simple',
                    data: [{ x: 0, y: 10 }, { x: 1, y: 20 }]
                }]);
                
                log(`Data set successfully`, 'success');
            }, 500);
        };
        
        window.testAllTypes = async function() {
            log('Testing all chart types...', 'info');
            
            const types = {
                'line': [{ label: 'Line', data: [{ x: 0, y: 10 }, { x: 1, y: 20 }, { x: 2, y: 15 }] }],
                'bar': [{ label: 'Bar', data: [{ x: 0, y: 30 }, { x: 1, y: 45 }, { x: 2, y: 20 }] }],
                'area': [{ label: 'Area', data: [{ x: 0, y: 5 }, { x: 1, y: 15 }, { x: 2, y: 10 }] }],
                'scatter': [{ label: 'Scatter', data: [{ x: 10, y: 20 }, { x: 30, y: 40 }, { x: 50, y: 30 }] }],
                'pie': [{ data: [{ label: 'A', value: 30 }, { label: 'B', value: 70 }] }],
                'donut': [{ data: [{ label: 'X', value: 40 }, { label: 'Y', value: 60 }] }],
                'radar': [{ label: 'Skills', data: [{ label: 'Speed', value: 80 }, { label: 'Power', value: 60 }, { label: 'Defense', value: 70 }] }],
                'heatmap': [{ data: [[10, 20, 30], [40, 50, 60], [70, 80, 90]] }]
            };
            
            for (const [type, data] of Object.entries(types)) {
                const chart = document.getElementById('chart1');
                chart.setType(type);
                chart.setData(data);
                
                await new Promise(r => setTimeout(r, 500));
                
                log(`${type} chart: ${chart._config.type === type ? '✓' : '✗'}`, chart._config.type === type ? 'success' : 'error');
            }
        };
        
        window.testPerformance = async function() {
            log('Starting performance test...', 'warning');
            
            const chart = document.getElementById('chart1');
            
            // Test with increasing data points
            const sizes = [10, 50, 100, 500, 1000];
            
            for (const size of sizes) {
                const data = [{
                    label: `${size} points`,
                    data: Array(size).fill(0).map((_, i) => ({
                        x: i,
                        y: Math.sin(i * 0.1) * 50 + 50 + Math.random() * 10
                    }))
                }];
                
                chart.setData(data);
                await new Promise(r => setTimeout(r, 1000));
                
                const fps = chart._fps || 0;
                log(`${size} points: ${fps.toFixed(1)} FPS`, fps > 30 ? 'success' : fps > 15 ? 'warning' : 'error');
            }
            
            log('Performance test complete', 'success');
        };
        
        window.checkConsoleErrors = function() {
            log(`\\nConsole Errors (${consoleErrors.length}):`, 'warning');
            consoleErrors.forEach(err => log(err, 'error'));
            
            log(`\\nConsole Warnings (${consoleWarnings.length}):`, 'warning');
            consoleWarnings.forEach(warn => log(warn, 'warning'));
        };
        
        // Initial setup
        setTimeout(async () => {
            log('Charts diagnostic ready', 'success');
            
            // Set initial data for visual feedback
            const charts = ['chart1', 'chartBar', 'chartPie', 'chartRadar', 'chartHeatmap'];
            const data = {
                chart1: [{
                    label: 'Revenue',
                    color: '#00ff00',
                    data: Array(20).fill(0).map((_, i) => ({
                        x: i,
                        y: Math.sin(i * 0.3) * 40 + 50
                    }))
                }],
                chartBar: [{
                    label: 'Sales',
                    color: '#00ffff',
                    data: [{ x: 0, y: 30 }, { x: 1, y: 45 }, { x: 2, y: 25 }, { x: 3, y: 60 }]
                }],
                chartPie: [{
                    data: [
                        { label: 'Desktop', value: 45, color: '#00ff00' },
                        { label: 'Mobile', value: 30, color: '#00ffff' },
                        { label: 'Tablet', value: 25, color: '#ff00ff' }
                    ]
                }],
                chartRadar: [{
                    label: 'Stats',
                    color: '#ff00ff',
                    data: [
                        { label: 'Speed', value: 75 },
                        { label: 'Power', value: 85 },
                        { label: 'Defense', value: 60 },
                        { label: 'Magic', value: 90 },
                        { label: 'Stamina', value: 70 }
                    ]
                }],
                chartHeatmap: [{
                    data: [
                        [10, 30, 50, 70, 90],
                        [20, 40, 60, 80, 100],
                        [15, 35, 55, 75, 95],
                        [25, 45, 65, 85, 95],
                        [30, 50, 70, 90, 100]
                    ]
                }]
            };
            
            for (const chartId of charts) {
                const chart = document.getElementById(chartId);
                if (chart && data[chartId]) {
                    chart.setData(data[chartId]);
                }
            }
            
            log('All test charts initialized with data', 'success');
            
            // Check WebGL support
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
            log(`WebGL support: ${!!gl}`, gl ? 'success' : 'warning');
            if (gl) {
                log(`WebGL Vendor: ${gl.getParameter(gl.VENDOR)}`, 'info');
                log(`WebGL Renderer: ${gl.getParameter(gl.RENDERER)}`, 'info');
            }
        }, 500);
    </script>
</body>
</html>