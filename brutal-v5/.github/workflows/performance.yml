name: Performance

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  bundle-size:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          
      - run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm build
        
      - name: Check size limits
        run: pnpm size
        
      - name: Generate size report
        run: |
          pnpm size --json > size-report.json
          
      - name: Comment PR with size
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('size-report.json', 'utf8'));
            
            let comment = '## üì¶ Bundle Size Report\n\n';
            comment += '| Package | Size | Limit | Status |\n';
            comment += '|---------|------|-------|--------|\n';
            
            for (const pkg of report) {
              const status = pkg.passed ? '‚úÖ' : '‚ùå';
              comment += `| ${pkg.name} | ${pkg.size} | ${pkg.limit} | ${status} |\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          
      - run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm build
        
      - name: Run benchmarks
        run: pnpm bench
        
      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: 'customBiggerIsBetter'
          output-file-path: benchmark-results.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true

  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          
      - run: pnpm install --frozen-lockfile
      
      - name: Build examples
        run: pnpm build:examples
        
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000
            http://localhost:3000/examples/basic
            http://localhost:3000/examples/advanced
          uploadArtifacts: true
          temporaryPublicStorage: true