<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRUTAL GPU Capabilities Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow-x: hidden;
        }
        
        .header {
            padding: 2rem;
            text-align: center;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border-bottom: 1px solid #333;
        }
        
        h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #00ff88, #00aaff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            color: #888;
            font-size: 1.2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .section {
            margin-bottom: 3rem;
            padding: 2rem;
            background: #1a1a1a;
            border-radius: 12px;
            border: 1px solid #333;
        }
        
        h2 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: #00ff88;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .info-item {
            padding: 1rem;
            background: #0f0f0f;
            border-radius: 8px;
            border: 1px solid #222;
        }
        
        .info-label {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .demo-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .demo-box {
            aspect-ratio: 1;
            background: #0f0f0f;
            border-radius: 8px;
            border: 1px solid #333;
            position: relative;
            overflow: hidden;
        }
        
        .demo-label {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            z-index: 10;
        }
        
        canvas {
            width: 100%;
            height: 100%;
        }
        
        .controls {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        button {
            padding: 0.75rem 1.5rem;
            background: #00ff88;
            color: #000;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #00cc70;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.secondary {
            background: #333;
            color: #fff;
        }
        
        button.secondary:hover {
            background: #444;
        }
        
        .slider {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .slider label {
            min-width: 100px;
            font-size: 0.9rem;
        }
        
        input[type="range"] {
            flex: 1;
            height: 6px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
            border-radius: 3px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #00ff88;
            cursor: pointer;
            border-radius: 50%;
        }
        
        .performance-stats {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.9);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #333;
            font-family: monospace;
            font-size: 0.9rem;
            min-width: 200px;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #888;
        }
        
        .stat-value {
            color: #00ff88;
            font-weight: 600;
        }
        
        .warning {
            background: #ff8800;
            color: #000;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .success {
            background: #00ff88;
            color: #000;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .error {
            background: #ff0044;
            color: #fff;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .performance-stats {
                position: relative;
                top: auto;
                right: auto;
                margin-top: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>BRUTAL GPU Test</h1>
        <p class="subtitle">Testing GPU Capabilities & Performance</p>
    </div>

    <div class="container">
        <!-- GPU Detection Results -->
        <div class="section">
            <h2>GPU Capabilities Detection</h2>
            <div id="detection-status"></div>
            <div class="info-grid" id="gpu-info">
                <div class="info-item">
                    <div class="info-label">Backend</div>
                    <div class="info-value" id="backend">Detecting...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Performance Score</div>
                    <div class="info-value" id="score">Calculating...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Max Texture Size</div>
                    <div class="info-value" id="texture-size">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Compute Units</div>
                    <div class="info-value" id="compute-units">-</div>
                </div>
            </div>
        </div>

        <!-- Particle System Demo -->
        <div class="section">
            <h2>Particle System Performance</h2>
            <div class="demo-container">
                <div class="demo-box">
                    <div class="demo-label">GPU Particles</div>
                    <canvas id="particle-canvas"></canvas>
                </div>
            </div>
            <div class="controls">
                <div class="slider">
                    <label>Particles:</label>
                    <input type="range" id="particle-count" min="1000" max="1000000" value="10000" step="1000">
                    <span id="particle-count-display">10,000</span>
                </div>
                <button id="emit-burst">Emit Burst</button>
                <button id="toggle-gravity" class="secondary">Toggle Gravity</button>
                <button id="toggle-attractor" class="secondary">Toggle Attractor</button>
            </div>
        </div>

        <!-- GPU Effects Demo -->
        <div class="section">
            <h2>GPU Effects</h2>
            <div class="demo-container">
                <div class="demo-box">
                    <div class="demo-label">Blur Effect</div>
                    <canvas id="blur-canvas"></canvas>
                </div>
                <div class="demo-box">
                    <div class="demo-label">Glow Effect</div>
                    <canvas id="glow-canvas"></canvas>
                </div>
                <div class="demo-box">
                    <div class="demo-label">Distortion Effect</div>
                    <canvas id="distortion-canvas"></canvas>
                </div>
            </div>
            <div class="controls">
                <button id="test-effects">Run All Effects</button>
                <div class="slider">
                    <label>Effect Intensity:</label>
                    <input type="range" id="effect-intensity" min="0" max="100" value="50">
                    <span id="effect-intensity-display">50%</span>
                </div>
            </div>
        </div>

        <!-- Benchmark Results -->
        <div class="section">
            <h2>Benchmark Results</h2>
            <div id="benchmark-results"></div>
            <div class="controls">
                <button id="run-benchmark">Run Full Benchmark</button>
                <button id="stress-test" class="secondary">Stress Test</button>
            </div>
        </div>
    </div>

    <!-- Performance Stats -->
    <div class="performance-stats">
        <div class="stat">
            <span class="stat-label">FPS:</span>
            <span class="stat-value" id="fps">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">Particles:</span>
            <span class="stat-value" id="active-particles">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">GPU Time:</span>
            <span class="stat-value" id="gpu-time">0ms</span>
        </div>
        <div class="stat">
            <span class="stat-label">Memory:</span>
            <span class="stat-value" id="memory">0MB</span>
        </div>
    </div>

    <!-- Load Framework -->
    <script type="module">
        import { GPUDetector } from '../03-visual/gpu/GPUDetector.js';
        import { ParticleSystem } from '../03-visual/gpu/ParticleSystem.js';
        import { GPUBlur } from '../03-visual/gpu/effects/GPUBlur.js';
        import { GPUGlow } from '../03-visual/gpu/effects/GPUGlow.js';
        import { GPUDistortion } from '../03-visual/gpu/effects/GPUDistortion.js';
        import { GPUBenchmark } from '../03-visual/gpu/GPUBenchmark.js';

        // Global state
        let detector = null;
        let particleSystem = null;
        let stats = {
            fps: 0,
            frameTime: 0,
            lastTime: performance.now(),
            frames: 0
        };

        // Initialize GPU detection
        async function initGPU() {
            detector = new GPUDetector();
            const capabilities = await detector.init();
            
            // Update UI with results
            updateDetectionUI(capabilities);
            
            // Initialize particle system
            await initParticleSystem();
            
            // Start render loop
            requestAnimationFrame(render);
        }

        // Update detection UI
        function updateDetectionUI(capabilities) {
            const statusEl = document.getElementById('detection-status');
            
            if (capabilities.score >= 80) {
                statusEl.innerHTML = '<div class="success">✓ High-performance GPU detected!</div>';
            } else if (capabilities.score >= 50) {
                statusEl.innerHTML = '<div class="warning">⚡ Medium-performance GPU detected</div>';
            } else {
                statusEl.innerHTML = '<div class="error">⚠ Low-performance GPU - some features may be limited</div>';
            }
            
            document.getElementById('backend').textContent = capabilities.backend.toUpperCase();
            document.getElementById('score').textContent = capabilities.score;
            
            if (capabilities.limits) {
                document.getElementById('texture-size').textContent = capabilities.limits.maxTextureSize || '-';
                document.getElementById('compute-units').textContent = capabilities.limits.maxComputeWorkGroupSize?.reduce((a, b) => a * b, 1) || '-';
            }
        }

        // Initialize particle system
        async function initParticleSystem() {
            const canvas = document.getElementById('particle-canvas');
            particleSystem = new ParticleSystem({
                maxParticles: 1000000,
                blendMode: 'additive'
            });
            
            await particleSystem.init(canvas);
            
            // Add initial spawner
            particleSystem.addSpawner({ x: 0, y: 0, z: 0 }, 100);
        }

        // Render loop
        function render(timestamp) {
            // Update stats
            stats.frames++;
            const deltaTime = timestamp - stats.lastTime;
            
            if (timestamp - stats.lastTime > 1000) {
                stats.fps = Math.round(stats.frames * 1000 / (timestamp - stats.lastTime));
                stats.frames = 0;
                stats.lastTime = timestamp;
                updateStats();
            }
            
            // Update particle system
            if (particleSystem && particleSystem.isInitialized) {
                particleSystem.update(deltaTime / 1000);
                
                // Simple camera matrices for now
                const viewProjection = new Float32Array([
                    1, 0, 0, 0,
                    0, 1, 0, 0,
                    0, 0, 1, 0,
                    0, 0, 0, 1
                ]);
                const view = viewProjection;
                
                particleSystem.render(viewProjection, view);
            }
            
            requestAnimationFrame(render);
        }

        // Update performance stats
        function updateStats() {
            document.getElementById('fps').textContent = stats.fps;
            document.getElementById('active-particles').textContent = particleSystem ? 
                particleSystem.getStats().particlesRendered.toLocaleString() : '0';
            document.getElementById('gpu-time').textContent = particleSystem ? 
                particleSystem.getStats().gpuTime.toFixed(2) + 'ms' : '0ms';
            
            if (performance.memory) {
                const memoryMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
                document.getElementById('memory').textContent = memoryMB + 'MB';
            }
        }

        // Event handlers
        document.getElementById('particle-count').addEventListener('input', (e) => {
            const count = parseInt(e.target.value);
            document.getElementById('particle-count-display').textContent = count.toLocaleString();
            
            if (particleSystem) {
                particleSystem.setConfig({ maxParticles: count });
            }
        });

        document.getElementById('emit-burst').addEventListener('click', () => {
            if (particleSystem) {
                // Emit burst at random position
                const x = (Math.random() - 0.5) * 200;
                const y = (Math.random() - 0.5) * 200;
                
                for (let i = 0; i < 10; i++) {
                    setTimeout(() => {
                        particleSystem.system.emit({
                            x, y, z: 0,
                            count: 1000,
                            speed: 5,
                            life: 2,
                            size: Math.random() * 2 + 1
                        });
                    }, i * 50);
                }
            }
        });

        document.getElementById('toggle-gravity').addEventListener('click', (e) => {
            if (particleSystem) {
                const currentGravity = particleSystem.config.gravity;
                particleSystem.setConfig({ gravity: currentGravity > 0 ? 0 : 9.81 });
                e.target.textContent = currentGravity > 0 ? 'Enable Gravity' : 'Disable Gravity';
            }
        });

        document.getElementById('toggle-attractor').addEventListener('click', (e) => {
            if (particleSystem) {
                const currentStrength = particleSystem.config.attractorStrength;
                particleSystem.setConfig({ 
                    attractorStrength: currentStrength > 0 ? 0 : 100,
                    attractorPos: { x: 0, y: 0, z: 0 }
                });
                e.target.textContent = currentStrength > 0 ? 'Enable Attractor' : 'Disable Attractor';
            }
        });

        document.getElementById('test-effects').addEventListener('click', async () => {
            // Test blur effect
            const blurEffect = new GPUBlur();
            await blurEffect.init();
            
            // Test glow effect
            const glowEffect = new GPUGlow();
            await glowEffect.init();
            
            // Test distortion effect
            const distortionEffect = new GPUDistortion();
            await distortionEffect.init();
            distortionEffect.startAnimation();
            
            console.log('GPU effects initialized successfully!');
        });

        document.getElementById('run-benchmark').addEventListener('click', async () => {
            const resultsEl = document.getElementById('benchmark-results');
            resultsEl.innerHTML = '<div class="warning">Running comprehensive GPU benchmark... This may take 10-20 seconds.</div>';
            
            // Create temporary canvas for benchmark
            const benchmarkCanvas = document.createElement('canvas');
            benchmarkCanvas.width = 1920;
            benchmarkCanvas.height = 1080;
            
            const benchmark = new GPUBenchmark();
            const report = await benchmark.runFullBenchmark(benchmarkCanvas);
            
            let html = '<div class="success">Benchmark Complete! Overall Score: ' + report.overall + '/100</div>';
            html += '<div class="info-grid">';
            
            for (const [testName, result] of Object.entries(report.tests)) {
                if (result) {
                    const statusClass = result.score >= 80 ? 'success' : result.score >= 50 ? 'warning' : 'error';
                    html += `
                        <div class="info-item">
                            <div class="info-label">${testName}</div>
                            <div class="info-value ${statusClass}">${result.score?.toFixed(1) || 'N/A'}</div>
                        </div>
                    `;
                }
            }
            html += '</div>';
            
            // Add detailed results
            html += '<h3 style="margin-top: 2rem;">Detailed Results:</h3>';
            html += '<pre style="background: #0f0f0f; padding: 1rem; border-radius: 8px; overflow-x: auto;">';
            html += benchmark.exportResults();
            html += '</pre>';
            
            resultsEl.innerHTML = html;
        });

        document.getElementById('stress-test').addEventListener('click', () => {
            if (particleSystem) {
                // Stress test with maximum particles
                particleSystem.setConfig({ maxParticles: 1000000 });
                
                // Create multiple spawners
                for (let i = 0; i < 10; i++) {
                    const angle = (i / 10) * Math.PI * 2;
                    particleSystem.addSpawner({
                        x: Math.cos(angle) * 100,
                        y: Math.sin(angle) * 100,
                        z: 0
                    }, 1000);
                }
                
                console.log('Stress test started - spawning 1M particles!');
            }
        });

        // Initialize on load
        window.addEventListener('load', initGPU);
    </script>
</body>
</html>